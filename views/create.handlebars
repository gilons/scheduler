<html>

<head>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link media="all" type="text/css" rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css">
    <link media="all" type="text/css" rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css">
    <style>
        #divAction {
            background-color: wheat;
            width: 250px;
            height: relative;
            border: 25% solid green;
            padding: 1%;
            margin: 2%;
            text-align: left;
        }

        #divAction2 {
            width: 100%;
        }

        body {
            min-width: 700px;
        }

        #divAbout {
            background-color: wheat;
            width: 700px;
            border: 25% solid green;
            padding: 1%;
            margin: 2%;
            height: relative

        }

        div.left {
            width: 20%;
            padding: 0 0 0 5%;
            float: left;
            size: 1%
        }

        div.right {
            width: 20%;
            padding: 0 5% 0 0;
            float: right;
        }

        .button {
            margin: 0px auto;
        }

        .button {
            margin: 0px auto;
        }

        #create {
            top: 5%;
            right: 15%;
            outline: none;
        }
        .dropbtn {
    height: 40px;
    color: white;
    border: none;
    cursor: pointer;
}

.dropbtn:hover, .dropbtn:focus {
    background-color: #2980B9;
}

.dropdown {
    position: relative;
    display: inline-block;
    padding-right: 160px;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f1f1f1;
    min-width: 132px;
    overflow: auto;
    z-index: 1;
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

.dropdown a:hover {background-color: #ddd}

.show {display:block;}
        .container {
            border-radius: 60px;
            background-color: white;
            width: relative; 
        }
    </style>
</head>

<body style="background-color:black">
    <br>
    <br>
    <div class="container">
        <div></div>
        <div id="divAbout" class="right">
          <center><form action="#" method="POST" id="createcourse">
                <table>
                    <center>
                        <label for=''>Faculty Name</label>
                    </center>
                    <center>
                        <input id="fac" type="text" value=""  style="width:30%" required>
                    </center>
                    <br>
                    <tr>
                        <td>
                            <label for="">Coursename</label>
                        </td>
                        <td>
                            <lable>N.R</lable>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input id="course" type="text" placeholder="name" style="width:90%" required>
                        </td>
                        <td>
                            <input type="number" id="noReg" placeholder="NoRegistered" style="width:80%;" required>
                        </td>
                        <td>
                            <input type="submit" value="save" style="width:100%; background-color:orange; border:0px">
                        </td>
                    </tr>
                </table>
            </form></center>
            <div id="faccourses"><center>
                <ul id="courses"></ul>
            </center></div>
            <br>
            <center>
                <div class="btn-group" style="font-size:80%">
                    <div class="left">
                        <button class=" btn-danger pull-right " id="dropFac" style="border:0; width:400%;">Drop For This Faculty</button>
                    </div>
                    <div class="right">
                        <button class="pull-left" id="facdone" style="border:0; width:400%; background-color:orange;">Change Faculty</button>
                    </div>
                </div>
                <div>
                    <button class="btn-success" style="border:0" id="schedule">schedule</button>
                </div>
                <br><br>
                <input type="button" class="btn btn-success btn-primary btn-sm" value="Show Scheduled" data-toggle="modal" id="scheduled"
                    data-target="#showscheduled" style="border:0px;  border-radius:0px">
            </center>
        </div>
            <div class="modal fade" id="showscheduled" data-backdrop="static" data-keyboard="false">
                <div class="modal-dialog" id="choose">  
                    <div class="modal-header">
                        <h4 class="modal-title">
                            <center id="detail1" style="background-color:#F7B432;">SCHEDULED COURSES</center>
                        </h4>
                    </div>
                    <div class="contain" id="changedscheduled">
                        {{#each week}}
                        <div id="{{this}}" class="gil" style="background-color:white; width:100% ">
                            <center>
                                <h4>WEEK-{{add1 this}}</h4>
                            </center>
                            <br>
                            <table style="width:100%" border="1" style="border-color:orange; background-color:dimgrey">
                                <tr>
                                    <th style="font-size:10px">
                                        <center>Day</center>
                                    </th>
                                    {{#each ../periods}}
                                    <th style="font-size:10px">
                                        <center>{{this}}</center>
                                    </th>{{/each}}
                                </tr>
                                {{#each ../day}}
                                <tr style="font-size:10px">
                                    <td>
                                        <center>{{this}}</center>
                                    </td>
                                    {{#each ../../periods}}
                                    <td id="{{id1 ../../this ..this this}}list" style="font-size:10px">
                                    </td>
                                    {{/each}}
                                </tr>
                                {{/each}}
                            </table>
                        </div>{{/each}}
                        <br>
                        <br>
                    </div>
                    <div class="modal-footer">
                    <div class="dropdown">
                        <center>
                        <button onclick="myFunction()" class="dropbtn" style="background-color:darkcyan">SELECT FACULTY</button>
                        </center>
                            <div id="myDropdown" class="dropdown-content">
                                <center>
                                    <a href="#" id="all" onclick="changefac(this.id)">All</a>
                                </center>
                                {{#each facs}}
                                <center><a href="#" id="{{this}}" onclick="changefac(this.id)">{{this}}</a></center>
                                {{/each}}
                            </div>
                        </div>
                        <button class="btn btn-default pull-right" id="close" data-dismiss="modal" style="border-radius:0%; color:white; border-color:#F7B432; background-color:orange"
                            title="close the window">CLOSE</button>
                            <button class="btn btn-default pull-left dropbtn" onclick="downloader()" style="border-radius:0%; color:black; border-color:#F7B432;"
                                title="Download Time Table">Download</button>
                    </div>
            
                </div>
            </div>
        <div id="divAction" class="left">
            <div id="divAction2">
                <center>
                    <h4>
                        <b>CREATE FACULTY</b>
                        <h4>
                            <form action="#" method="POST" id="create">
                                <table>
                                    <tr>
                                        <td>
                                            <label for="">name</label>
                                        </td>
                                        <td>
                                            <lable>password</lable>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input id="facname" type="text" placeholder="name" style="width:90%" required>
                                        </td>
                                        <td>
                                            <input type="password" id="password" placeholder="password" style="width:80%;" required>
                                        </td>
                                        <td>
                                            <input type="submit" value="save" style="width:100%; background-color:orange; border:0px">
                                        </td>
                                    </tr>
                                </table>
                            </form>
                            <br>
                            <br>
                            <div>
                                <center>
                                    <h4>
                                        <b>ADDED FACULTY</b>
                                    </h4>
                                </center>
                                <ul id="facs">
                                    {{#each facs}}
                                    
                                       <tr><td><h5 style="color:black;">{{this}}</h5></td>
                                    <td><button id="{{this}}" class="btn-danger" style="font-size:70%; border:0px;" onclick="dropSingleFac(this.id)">drop</button></td></tr>
                                    
                                    {{/each}}
                                </ul>
                            </div>
                            <br>
                            <br>
                            <center>
                                <div class="btn-group" style="font-size:80%">
                                    <div class="left">
                                        <button class=" btn-danger pull-right " id="dropALL" style="border:0; width:400%; font-size:80%">Drop All</button>
                                    </div>
                                    <div class="right">
                                        <button class="pull-left" id="facrefresh" style="border:0; width:400%;font-size:80%; background-color:orange;">Refresh</button>
                                    </div>
                                </div>
                            </center>
                            <br>
                            <div style="background-color:floralwhite;height:10%">
                                <center>
                                    <h4>
                                        This is your KeyWord:
                                    </h4>
                                    <h5>
                                        {{keyword}}
                                    </h5>
                                </center>
                            </div>

                </center>
            </div>
        </div>
</body>
<script type="text/javascript" scr="handlebars-v4.0.11.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.js"> </script>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.js"></script>
<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src='/pdfmake-master/build/pdfmake.min.js'></script>
<script src='/pdfmake-master/build/vfs_fonts.js'></script>
<script type="text/javascript">
var facname = null;
var password = null;
var schedule = [];
</script>
<script type="text/javascript">
    function comparator(a, b) {
        if (a[0] > b[0]) return -1;
        if (a[0] < b[0]) return 1;
        return 0;
    }
    function objectify(array, callback) {
            var temp = {};
            for (var i = 0; i < array.length; i++) {
                temp[array[i][0]] = array[i][1];
                if (i === array.length - 1) {
                    callback(temp);
                }
            }
        }
    function changefac(clicked){
        event.preventDefault();
        if(clicked === 'all'){
            var noweeks = {{{ tojava week }}};
            var day = {{{ tojava day }}};
            var periods = {{{ tojava periods }}};
             var scheduled = {{{ tojava scheduled }}};
             alert(scheduled);
            objectify(scheduled,function(scheduler){
                createfacscheduled(periods, day, noweeks, scheduler, function (made) {
                     document.getElementById("changedscheduled").innerHTML = made;
                     schedule = scheduled
                 });
            })
        }else{
              $.post("http://localhost:3000/changescheduled", { value: clicked }, function (schedulex) {
                schedule = arrtransform(schedulex) 
                var noweeks = {{{ tojava week }}};
                var day = {{{ tojava day }}};
                var periods = {{{ tojava periods }}};
                createfacscheduled(periods, day, noweeks, schedulex, function (made) {
                    document.getElementById("changedscheduled").innerHTML = made;
                });
            
        });
        }
    }
     function myFunction() {
            document.getElementById("myDropdown").classList.toggle("show");
        }
        function downloadlist() {
                document.getElementById("downloads").classList.toggle("show");
            }

    function createfacscheduled(periods,day,noweeks,scheduled,callback){
             var make = '';
            for(var i = 0 ; i < noweeks.length; i ++){
                var tempweek = noweeks[i] + 1;
                make += '<div id="facweek' + noweeks[i] + '" class="gil" style="background-color:white; width:100% ">';
                make += '<center><h4>WEEK-' + tempweek + '</h4></center><br>';
                make += '<table style="width:100%" border="1" style="border-color:orange; background-color:dimgrey"><tr><th style="font-size:10px"><center>Day</center></th>';
                for(var j = 0 ; j < periods.length ; j++){
                    make += '<th style="font-size:10px"><center>' + periods[j] + '</center></th>';
                }
                make += '</tr>';
                    for(var s = 0 ; s < day.length ; s++){
                        make += '<tr style="font-size:10px"><td><center>' + day[s] + '</center> </td>';
                        for(var x = 0; x< periods.length; x++){
                            var index = noweeks[i] + day[s].substr(0, 3) +'_'+ periods[x].substr(0, 2);
                            make +=  '<td id="' + index + 'fac" style="font-size:10px">'+scheduled[index]+'</td>';
                        }
                        make += '</tr>';
                    }
                    make +=  '</table></div>';
                make += '<br><br>';
            }
            callback(make);
    }

        // Close the dropdown if the user clicks outside of it
        window.onclick = function (event) {
            if (!event.target.matches('.dropbtn')) {

                var dropdowns = document.getElementsByClassName("dropdown-content");
                var i;
                for (i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }
    $('#schedule').on('click',function(){
        window.location = 'http://localhost:3000/doitalone'
    })
     function writeskeduled(scheduled) {
        for (var i = 0; i < scheduled.length; i++) {
            var id = scheduled[i][0] + "list";
            document.getElementById(id).innerHTML = null;
            document.getElementById(id).innerHTML = "<tr><td>" + scheduled[i][1] + "</td></tr>";
        }
    }
    function longest(collection, callback) {
        var temp = [];
        for (var i = 0; i < collection.length; i++)
            if (collection[i][1][0]) {
                temp.push(collection[i][1].indexOf(collection[i][1][collection[i][1].length - 1]));
            }
        if (i === collection.length) {
            callback(temp.sort()[temp.length-1]);
        }
    }
    function dropSingleFac(facname){
        $.post("http://localhost:3000/dropsingle", { value: facname }, function (data) {
            location.reload();
        });
    }
    function arrtransform(array) {
            var temp = [];
            var i = 0;
            for (var key in array) {
                temp.push([key, array[key]]);
            }
            return temp;
        }
    function downloader (){
        event.preventDefault();
        if(schedule[0] === undefined){
        schedule = {{{ tojava scheduled }}};    
        }
            var periods = {{{ tojava periods }}};
            periods = addday(periods);
             var docDefinition = {};
            var day = {{{ tojava day }}};
            var week = {{{ tojava week }}};
            var period = {{{ tojava period }}};
            generatetable(periods, day, week, schedule, period, function (tabledata) {
                 docDefinition = {
                    content: [
                       {
                            table: {
                                headerRows: 1,
                                widths: ['auto', 'auto', 'auto', 'auto'],

                                body: tabledata
                            }
                            , fontSize: 7
                        }
                    ]
                };
                 pdfMake.createPdf(docDefinition).open(); 
            });      
    }
    $("#dropFac").on('click', function () {
        var r = confirm("Your are about to drop all courses for this faculty");
        if (r == true) {
           var temp = $('#fac').val()
            var data =[];
            data.push($('#fac').val());
            data.push("dropFac");
            $.ajax({
                type: 'POST',
                data: JSON.stringify(data),
                contentType: "application/json",
                url: "http://localhost:3000/drop",
                success: function (data) {
                    if(data === 'dropFac'){
                        location.reload();
                    }else if(data === 'drop'){

                }else{
                    location.reload();
                }
                }
            });
        }
        });
            $("#dropALL").on('click', function () {
                var r = confirm("Your are about to drop all faculties for this faculty");
                if(r == true){
                      var data = [];
                    $.ajax({
                        type: 'POST',
                        data: JSON.stringify(data),
                        contentType: "application/json",
                        url: "http://localhost:3000/drop",
                        success: function (data) {
                            if (data === 'dropFac') {
                                location.reload();
                            } else if (data === 'drop') {

                            } else {
                                location.reload();
                            }
                        }
                    });
                }
                });
    function producecourseColect(collection, callback) {
        var limit = collection.length;
        var temp2 = '';
        var j = 0;
        var s = 0;
        var j = 0;
        var temp = '<center><table border = "1"><tr>';
        longest(collection, function (longestlength) {  
            for ( s = 0; s < collection.length; s++) {
                temp2 = '<th>' + collection[s][0] + '</th>';
                temp += temp2;
                if (s === collection.length - 1) {
                    temp += '<tr>';
                }
            }
            for (i = 0; i <= longestlength; i++) {
                temp += '<tr>';
                    j = 0;
                for (j = 0; j < limit; j++) {
                    if (collection[j][1][i] === undefined) {temp += '<td></td>'}else{
                        temp2 = '<td>' + collection[j][1][i][0] + '&emsp13; &emsp13;'
                            + collection[j][1][i][1] + '&emsp13; <button class=" btn-danger" style="font-size:67%; border:0; width:100%;" id ="'+collection[j][0]+'.'+ collection[j][1][i][0]
                            +'" onClick = "dropthisCourse(this.id)">Drop</button></td>';
                        temp += temp2;

                    }   
                }
                temp += '</tr>';
            }
            temp += '</table></center>';
        });
         callback(temp);
    }
    function dropthisCourse(courseid) {
     $.post("http://localhost:3000/dropthis", { value: courseid }, function (data) {
       location.reload();  
     });
    }
    function checkperiod(scheduled, period) {
                for(var i = 0 ; i <scheduled.length ; i++){
                    if (scheduled[i][0] === period) return i;
            }
        }
    function generatetable(periods,day,week,scheduled,period,callback){
        var temp = [periods];
        var i = 0;
        var x = 0;
        var j = 0;
        for (i = 0; i < week.length; i++) {
            for (j = 0; j < day.length; j++) {
                var temp2 = [];
                temp2.push(day[j]);
                for (x = 0; x < periods.length-1; x++) {
                    var tempo = { table: { width: ['auto', 'auto'], headerRows: 1, body: [[{ text: 'Course', style: 'tableHeader' }, { text: 'Venue', style: 'tableHeader' }]] } };
                    var address = week[i] + day[j].substr(0, 3) + '_' + periods[x + 1].substr(0, 2);
                    var index = checkperiod(scheduled,address);
                           if (scheduled[index][1]) {
                            var temparray = scheduled[index][1].split('<br/>');
                            for (var y = 0; y < temparray.length; y++) {
                                var tempstring = temparray[y].split('<br>');
                                for(var z = 0; z < tempstring.length ; z++){
                                    if(tempstring[z]){
                                                 alert(tempstring[z]);
                                        tempo.table.body.push([tempstring[z].split('-')[0], tempstring[z].split('-')[1]]);
                                    }
                                }
                            }
                            temp2.push(tempo);
                        } else {
                            temp2.push('');
                        }
                }
                temp.push(temp2);
            }
            j = 0;
            x = 0;
        }
        callback(temp);
    }
    function addday(periods){
        var temp = ['Day'];
        for( var i = 0; i < periods.length ; i++){
            temp.push(periods[i]);
        }
        return temp;
    }
    $(document).ready(function () {
            var temp = {{{ tojava collection }}};
            producecourseColect(temp, function (result) {
                document.getElementById('faccourses').innerHTML += result;
                var someVarName = localStorage.getItem("facname");
                var somePassword = localStorage.getItem('password');
                document.getElementById('fac').value = someVarName
                document.getElementById('password').value = somePassword;
                var scheduled = {{{tojava scheduled}}};
                writeskeduled(scheduled);
            });
    });
    $("#createcourse").on('submit', function (event) {
        event.preventDefault();
        var name = [];
        name[0] = $("#fac").val();
        name[1] = $("#noReg").val();
        name[2] = $('#course').val();
        name[3] = 'createcoure';
        var data = {};
        data.value = name;
        $.ajax({
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            url: "http://localhost:3000/faccreate",
            success: function (data) {
                if (data == "noFac") {
                    alert("Please check your Fac name  and retry and ensure that the course does not already exists");
                }else{
                     facname = data[2];
                     localStorage.setItem("facname", facname);
                     location.reload();
                }

            }
        })

    });

    $('#facdone').on('click', function () {
        location.reload();
    })
    $('#facrefresh').on('click', function () {
        location.reload();
    })

    $("#create").on('submit', function (event) {
        event.preventDefault();
        var name = [];
        name[0] = $("#facname").val();
        name[1] = $("#password").val();
        password = name[1];
        name[2] = 'fac';
        var data = {};
        data.value = name;
        $.ajax({
            type: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            url: "http://localhost:3000/faccreate",
            success: function (data) {
                if (data == "no") {
                    alert("Please check your password and retry and ensure that the university does not already exists");
                } else {
                    var facs = '<li><h5 style="color:weath;">' + data + '</h5></li>';
                    document.getElementById("facs").innerHTML += facs;
                    var message = data + " was successfuly added";
                    document.getElementById("createerror").innerHTML += message
                    localStorage.setItem('password',password);
                    location.reload();
                }

            }
        })

    });
</script>

</html>